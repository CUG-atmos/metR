<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualization tools • metR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">metR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Visualization-tools.html">Visualization tools</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/eliocamp/metR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Visualization tools</h1>
                        <h4 class="author">Elio Campitelli</h4>
            
            <h4 class="date">2018-01-27</h4>
          </div>

    
    
<div class="contents">
<p>One of the “conceptual branches” of metR is the <em>visualization tools</em>. These are a set of functions that interface with <a href="http://ggplot2.tidyverse.org/index.html">ggplot2</a> for easier and better plotting.</p>
<div id="scales" class="section level2">
<h2 class="hasAnchor">
<a href="#scales" class="anchor"></a>Scales</h2>
<p>Many meteorological fields are defined in a longitude×latitude×level grid, so metR includes scales for each dimension. These are glorified wrapers around <code>scale_*_continuous()</code> with sensible defaults and, in the case of <code>scale_*_level()</code>, the implementation of <code><a href="../reference/reverselog_trans.html">reverselog_trans()</a></code>.</p>
<p>There’s also <code>scale_*_divergent()</code> which are wrapers around <code>scale_*_gradient2()</code> but with sane default colors for positive and negative values -particularily useful for plotting anomaly values.</p>
<p>To see how this scales work, let’s visualize the vertical distribution of temperature anomalies from the zonal mean.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(metR)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(data.table)
nceptemperature &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/copy">copy</a></span>(nceptemperature)
nceptemperature[, air.z <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/Anomaly.html">Anomaly</a></span>(air), by =<span class="st"> </span>.(lat, lev)]

<span class="co"># Plot made with base ggplot</span>
g &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(nceptemperature[lon <span class="op">%~%</span><span class="st"> </span><span class="dv">180</span>], <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lat, lev, <span class="dt">z =</span> air.z)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color =</span> ..level..))

g</code></pre></div>
<p><img src="Visualization-tools_files/figure-html/unnamed-chunk-1-1.png" width="672"></p>
<p>While this is fine, since pressure levels are roughly proportional to <span class="math inline">\(\mathrm{e}^{-z}\)</span> in meteorology we usually plot the vertical coordinate as <span class="math inline">\(-\log(p)\)</span>. However, while ggplot2 has <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_log10()</a></code> and <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_reverse()</a></code>, they don’t work together. metR defines a new transformation <code><a href="../reference/reverselog_trans.html">reverselog_trans()</a></code> that can be used with any scale but that is the default for <code>scale_*_level()</code>.</p>
<p>On the other hand, <code>scale_*_latitude()</code> (and <code>scale_*_longitude()</code>) not only sets <code>expand</code> to <code>c(0, 0)</code>, but also has a <code>ticks</code> argument that specifies the spacing of breaks.</p>
<p>These scales default to printing no label, since usually the dimensions are understood by the shape of the plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_y_level</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_x_latitude</a></span>(<span class="dt">ticks =</span> <span class="dv">15</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_divergent.html">scale_color_divergent</a></span>()</code></pre></div>
<p><img src="Visualization-tools_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Note: <code>scale_*_longitude()</code> (currently) assumes the data goes from 0° to 360° but puts labels between -180° and 180°. This very idiosyncratic choice stems from the fact that model output is usually in the [0; 360) range but it’s easier to read maps in the (-180; 180] range. In the futre this may change.</p>
</div>
<div id="geoms-and-stats" class="section level2">
<h2 class="hasAnchor">
<a href="#geoms-and-stats" class="anchor"></a>Geoms and stats</h2>
<p>metR implements one geom and one stat.</p>
<div id="stat_contour_fill" class="section level3">
<h3 class="hasAnchor">
<a href="#stat_contour_fill" class="anchor"></a>stat_contour_fill()</h3>
<p>In ggplot2, the ‘canonical’ way to get filled contours is by using <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">stat_contour()</a></code> with a <code>polygon</code> geom and mapping <code>fill</code> to <code>level</code>. This has tree important limitations.</p>
<ul>
<li><p>It doesn’t work well for contours that end at the edges</p></li>
<li><p>External contours sometimes hide internal ones (small red contour in the figure)</p></li>
<li><p>There’s no distinction between contours with the same level but different internal values (blue contours in the figure)</p></li>
</ul>
<p><code><a href="../reference/geom_contour_fill.html">stat_contour_fill()</a></code> makes some adjustments to the data and computes an aditional variable <code>int.level</code> (which is de defautl mapping for the <code>fill</code> aesthetic) that solve these problems.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">breaks =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">100</span>, <span class="dv">200</span>, <span class="dt">by =</span> <span class="dv">10</span>)
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/melt.data.table">melt</a></span>(volcano), <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(Var1, Var2, <span class="dt">z =</span> value)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">stat_contour</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">fill =</span> ..level..), <span class="dt">geom =</span> <span class="st">"polygon"</span>, <span class="dt">breaks =</span> breaks) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="dt">color =</span> <span class="st">"red"</span>, <span class="dt">size =</span> <span class="fl">0.2</span>, <span class="dt">breaks =</span> <span class="dv">150</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="dt">color =</span> <span class="st">"blue"</span>, <span class="dt">size =</span> <span class="fl">0.2</span>, <span class="dt">breaks =</span> <span class="dv">160</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/melt.data.table">melt</a></span>(volcano), <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(Var1, Var2, <span class="dt">z =</span> value)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_contour_fill.html">stat_contour_fill</a></span>(<span class="dt">breaks =</span> breaks)</code></pre></div>
<p><img src="Visualization-tools_files/figure-html/unnamed-chunk-3-1.png" width="316.8"><img src="Visualization-tools_files/figure-html/unnamed-chunk-3-2.png" width="316.8"></p>
<p>Neat, hu? :D It’s important to note that this stat currently only works with rectangular grids and does not play well with missing values.</p>
<p>We can apply this to a more realistic dataset</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(nceptemperature[lev <span class="op">==</span><span class="st"> </span><span class="dv">300</span>], <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat, <span class="dt">z =</span> air.z)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_contour_fill.html">stat_contour_fill</a></span>(<span class="dt">exclude =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_divergent.html">scale_fill_divergent</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_x_longitude</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_y_latitude</a></span>()
g</code></pre></div>
<p><img src="Visualization-tools_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
</div>
</div>
<div id="geom_vector" class="section level2">
<h2 class="hasAnchor">
<a href="#geom_vector" class="anchor"></a>geom_vector</h2>
<p>Plotting arrows can be a pain, so <code><a href="../reference/geom_vector.html">geom_vector()</a></code> is a parametrization of <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_segment">geom_segment()</a></code> by location and displacement in each direction. <code>min.mag</code> controls the minimum magnitude for an arrow to be drawn (useful for highlighting only areas of strong ‘flow’) and <code>skip = n</code> draws only the nth arrow in the x direction and the mth arrown in the y direction (only meaningful for regular grids!).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nceptemperature[, <span class="kw">c</span>(<span class="st">"t.dx"</span>, <span class="st">"t.dy"</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/Derivate.html">Derivate</a></span>(air.z <span class="op">~</span><span class="st"> </span>lon <span class="op">+</span><span class="st"> </span>lat, 
                                               <span class="dt">cyclical =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>), 
                                               <span class="dt">sphere =</span> T), 
                by =<span class="st"> </span>lev]

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(nceptemperature[lev <span class="op">==</span><span class="st"> </span><span class="dv">500</span>], <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_contour_fill.html">stat_contour_fill</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> air.z)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_vector.html">geom_vector</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">dx =</span> t.dx, <span class="dt">dy =</span> t.dy), <span class="dt">skip.x =</span> <span class="dv">2</span>, <span class="dt">skip.y =</span> <span class="dv">1</span>, <span class="dt">scale =</span> <span class="fl">5e5</span>, <span class="dt">min.mag =</span> <span class="fl">2e-6</span>,
               <span class="dt">arrow.size =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_y_latitude</a></span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">90</span>, <span class="dv">0</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_x_longitude</a></span>()</code></pre></div>
<pre><code>## Warning: Ignoring unknown parameters: arrow.size</code></pre>
<pre><code>## Warning: Removed 5328 rows containing non-finite values (stat_vector).</code></pre>
<pre><code>## Warning: Removed 2 rows containing missing values (geom_segment).</code></pre>
<p><img src="Visualization-tools_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>The parameters <code>scale</code>, <code>arrow.size</code> and <code>arrow.angle</code> modify the length of the segments, and the size and angle of the arrowheads.</p>
<p>There are (currently) many limitations of <code><a href="../reference/geom_vector.html">geom_vector()</a></code>:</p>
<ul>
<li><p>When the x and y units of the plotting area are not in the same units as the displacement values (as in the example), there’s a fair amount of manual tweaking needed to get things right.</p></li>
<li><p>Related to that, if there is no consistent way of comparing the displacement unit to the x or y units there is no garantee of accuracy. See how in the example the meridional magnitude is exagerated compared to the zonal magnitude.</p></li>
<li><p>It breaks if any dimension is discrete or date/date_time.</p></li>
<li><p>It does not preserve direction under coordinate transformations, i.e wind coming from the south west will appear to come from the west south west if the x coordinate is stretched, but it will still be parallel to streamlines.</p></li>
<li><p>Vectors that cross the dateline cause problems when using map proyections since they extend the data to values outside the bounds of the map.</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="../reference/RepeatLon.html">RepeatLon</a></span>(nceptemperature[lev <span class="op">==</span><span class="st"> </span><span class="dv">500</span>]), <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_contour_fill.html">stat_contour_fill</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> air.z)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_y_latitude</a></span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">80</span>, <span class="dv">0</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_x_longitude</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_divergent.html">scale_fill_divergent</a></span>(<span class="dt">guide =</span> <span class="st">"none"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_map</a></span>()

g 
g <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/geom_vector.html">geom_vector</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">dx =</span> t.dx, <span class="dt">dy =</span> t.dy), <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">scale =</span> <span class="fl">5e5</span>, <span class="dt">min.mag =</span> <span class="fl">2e-6</span>,
               <span class="dt">arrow.size =</span> <span class="fl">0.3</span>) </code></pre></div>
<p><img src="Visualization-tools_files/figure-html/unnamed-chunk-6-1.png" width="316.8"><img src="Visualization-tools_files/figure-html/unnamed-chunk-6-2.png" width="316.8"></p>
</div>
<div id="repeatlon" class="section level2">
<h2 class="hasAnchor">
<a href="#repeatlon" class="anchor"></a>RepeatLon</h2>
<p>The function <code><a href="../reference/RepeatLon.html">RepeatLon()</a></code> is an ugly kludge to fix an issue when using polar coordinates in ggplot2. Contours that cross the dateline are not properly rendered. The workaround is to copy the leftmost data and place it to the right.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">g &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(nceptemperature[lev <span class="op">==</span><span class="st"> </span><span class="dv">300</span>], <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat, <span class="dt">z =</span> air.z)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="dt">binwidth =</span> <span class="fl">1.5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_divergent.html">scale_fill_divergent</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_x_longitude</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_longitude.html">scale_y_latitude</a></span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">90</span>, <span class="op">-</span><span class="dv">20</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_polar">coord_polar</a></span>()

g

g <span class="op">%+%</span><span class="st"> </span><span class="kw"><a href="../reference/RepeatLon.html">RepeatLon</a></span>(nceptemperature[lev <span class="op">==</span><span class="st"> </span><span class="dv">300</span>]) </code></pre></div>
<p><img src="Visualization-tools_files/figure-html/unnamed-chunk-7-1.png" width="316.8"><img src="Visualization-tools_files/figure-html/unnamed-chunk-7-2.png" width="316.8"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#scales">Scales</a></li>
      <li><a href="#geoms-and-stats">Geoms and stats</a></li>
      <li><a href="#geom_vector">geom_vector</a></li>
      <li><a href="#repeatlon">RepeatLon</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Elio Campitelli.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
